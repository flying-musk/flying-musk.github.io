import{r as e,X as a,T as t,o as l,q as n,G as s,H as o,x as i,C as r,a as m,w as d,D as c,U as p,u,N as f,c as b,O as h,h as y,a3 as g,f as x,A as v,Z as w,S as Y,Q as k,$ as _}from"./element-plus.4376cb67.js";import{r as C,_ as D}from"./index.2e435e4a.js";import{_ as T}from"./index.47575a41.js";import{_ as M}from"./CardTwoCol.c5188255.js";import{_ as S}from"./SubTitle.11cb64b0.js";import{S as V}from"./ScrollToTop.6f304746.js";const j=e=>C({url:"api/sys/mbtax_verify.php",method:"post",data:e}),F={class:"tracking-wider text-gray-500 text-xs"},O={class:"flex justify-between items-center border-b bg-white text-gray-500 p-2"},$={class:"grid grid-cols-2 border-t divide-x py-2 text-sm"},A=["onClick"],U=["onClick"],L=["onClick"],R=i("span",null," 下載檔案 ",-1),z={__name:"TaxCard",props:{list:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["on-download","verify-tax"],setup:(y,{emit:g})=>(x,v)=>{const w=e("el-tag"),Y=e("Download"),k=e("el-icon"),_=e("el-empty"),C=a("loading");return t((l(),n("div",F,[(l(!0),n(s,null,o(y.list,((e,a)=>(l(),n("div",{class:"grid grid-cols-1 bg-white rounded mb-3",key:e.name},[i("header",O,[i("div",null,"#"+r(a+1)+"｜"+r(e.filetime),1),m(w,{effect:"plain",round:"",size:"small",type:e.statusType},{default:d((()=>[c(r(e.status),1)])),_:2},1032,["type"])]),m(M,{item:{label:"姓名",value:`${e.member.mbid}｜${e.member.name}`}},null,8,["item"]),m(M,{item:{label:"手機",value:e.member.phone}},null,8,["item"]),m(M,{item:{label:"E-mail",value:e.member.email}},null,8,["item"]),m(M,{item:{label:"税號",value:e.member.taxno}},null,8,["item"]),m(M,{item:{label:"檔案",value:e.name}},null,8,["item"]),i("footer",$,[t(i("div",{class:"text-center cursor-pointer hover:opacity-70 text-primary-500",onClick:a=>g("verify-tax",{file:e.name,type:"verify"})}," 通過 ",8,A),[[p,!e.name.includes("verified")]]),t(i("div",{class:"text-center cursor-pointer hover:opacity-70 text-red-400",onClick:a=>g("verify-tax",{file:e.name,type:"revoke"})}," 撤銷 ",8,U),[[p,e.name.includes("verified")]]),i("div",{class:"justify-center cursor-pointer hover:opacity-70 text-gray-500 flex items-center gap-x-1",onClick:a=>g("on-download",{name:e.name,path:e.path})},[R,m(k,null,{default:d((()=>[m(Y)])),_:1})],8,L)])])))),128)),u(f)(y.list)?(l(),b(_,{key:0})):h("",!0)])),[[C,y.loading]])}};const E={id:"tax-setting",class:"taxSetting h-full reactive"},H={class:"flex flex-col gap-y-3 md:bg-white md:h-full md:p-3 rounded-md"},q={class:"flex items-center justify-between"},B={class:"flex items-center gap-x-3"},I={class:"flex flex-col md:flex-row md:justify-between gap-y-3"},N={class:"flex flex-col md:flex-row gap-3 items-center"},G={class:"flex justify-between"},Q={class:"flex flex-col w-full md:w-fit gap-3 md:flex-row"},X={class:"text-gray-500 self-end px-1"},Z={class:"text-xs leading-5 flex items-center gap-x-1 w-full"},J={class:"flex flex-col px-2"},K={class:"tracking-widest font-thin"},P=["onClick"],W=["onClick"],ee=["onClick"];var ae=D({__name:"index",setup(a){const{proxy:f}=k(),h=y({loading:!1,showSetting:!0,showSettingMobile:!1,selectedDate:g().format("YYYYMM"),dateOptions:[g().format("YYYYMM"),g().subtract(1,"month").format("YYYYMM"),g().subtract(2,"month").format("YYYYMM"),g().subtract(3,"month").format("YYYYMM"),g().subtract(4,"month").format("YYYYMM"),g().subtract(5,"month").format("YYYYMM")],search:"",searchOptions:[],pagination:{show:!0,total:0,page:1,take:20},columns:[{label:"時間",prop:"filetime",width:"130",sortable:!0},{label:"會員資料",prop:"member",sortable:!0,formatter:!0},{label:"文件名稱",prop:"name",sortable:!0,formatter:!0,width:"280"},{label:"狀態",prop:"status",formatter:!0,width:"100",align:"center"},{label:"操作",prop:"action",formatter:!0,width:"100",align:"center"}],tableData:[]}),D=x((()=>{const{page:e,take:a}=h.pagination;if(h.search){const t=h.tableData.filter((e=>e.member.mbid===h.search)),l=t.filter(((t,l)=>l<e*a&&l>=a*(e-1)));return h.pagination.total=t.length,l}return h.pagination.total=h.tableData.length,h.tableData.filter(((t,l)=>l<e*a&&l>=a*(e-1)))})),M=x((()=>{if(h.search){return h.tableData.filter((e=>e.member.mbid===h.search))}return h.tableData}));v((()=>{F.handleFetchAll()}));const F={handleFetchAll:async()=>{h.loading=!0;const e={action:"list_all",yrmo:h.selectedDate},{code:a,data:t=[],count:l=0,msg:n}=await j(e);if(setTimeout((()=>{h.loading=!1}),500),1===a){h.tableData=t,h.tableData.forEach((e=>{const a=1e3*e.filetime;e.status=F.handleFormatStatus(e.name),e.statusType=F.handleFormatStatusType(e.name),e.filetime=g(a).format("YYYY-MM-DD HH:mm:ss")})),h.pagination.total=Number(l);const e=t.map((e=>e.member)).flat().map((e=>({member_id:e.mbid,name:e.name})));h.searchOptions=w(e,_)||[]}else f.$message({type:"error",message:n})},handleRest:()=>{h.search="",h.selectedDate=g().format("YYYYMM"),F.handleFetchAll()},handleVerifyTax:async e=>{const{file:a,type:t,action:l="set_verified"}=e,{code:n,data:s,msg:o}=await j({file:a,type:t,action:l});1===n&&F.handleFetchAll(),f.$message({type:n>0?"success":"error",message:o})},handleScrollToTop:()=>{const e=document.querySelector("#tax-setting");e&&e.scrollIntoView({behavior:"smooth"})},handleFormatMemberLabel:e=>({mbid:"編號",name:"姓名",taxno:"稅號",phone:"電話",email:"信箱"}[e]),handleFormatStatus:e=>e.includes("verified")?"已驗證":"未驗證",handleFormatStatusType:e=>e.includes("verified")?"success":"info",handleDownload:async e=>{const a={file:e.name,path:e.path};try{const l=await(t=a,C({url:"api/filedl.php",method:"post",responseType:"blob",data:t})),n=window.URL.createObjectURL(new Blob([l])),s=document.createElement("a");s.href=n,s.setAttribute("download",e.name),document.body.appendChild(s),s.click()}catch(l){f.$message({type:"error",message:"下載發生錯誤，請稍後再試"})}var t}};return(a,f)=>{const y=e("el-option"),g=e("el-select"),x=e("el-button"),v=e("Download"),w=e("el-icon"),k=e("el-tag");return l(),n("div",E,[i("div",H,[i("header",q,[i("div",B,[m(S,{title:"稅務表格",class:"min-w-fit"}),m(g,{modelValue:h.selectedDate,"onUpdate:modelValue":f[0]||(f[0]=e=>h.selectedDate=e),"value-key":"value",placeholder:"月份",size:"small",class:"max-w-[120px] select-date",onChange:F.handleFetchAll},{prefix:d((()=>[c("月份")])),default:d((()=>[(l(!0),n(s,null,o(h.dateOptions,(e=>(l(),b(y,{key:e,label:`${e}`,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])]),i("div",I,[i("div",N,[m(g,{modelValue:h.search,"onUpdate:modelValue":f[1]||(f[1]=e=>h.search=e),"value-key":"value",placeholder:"會員編號",clearable:"",filterable:"",class:"w-full md:w-fit"},{default:d((()=>[(l(!0),n(s,null,o(h.searchOptions,(e=>(l(),b(y,{key:e.member_id,label:`${e.member_id}｜${e.name}`,value:e.member_id},{default:d((()=>[i("div",G,[i("span",null,r(e.member_id),1),i("span",null,r(e.name),1)])])),_:2},1032,["label","value"])))),128))])),_:1},8,["modelValue"]),i("div",Q,[m(x,{type:"primary",class:"w-full md:w-fit","auto-insert-space":""},{default:d((()=>[c("搜尋")])),_:1}),i("div",null,[m(x,{bg:"","auto-insert-space":"",class:"w-full md:w-fit",onClick:F.handleRest},{default:d((()=>[c("重置")])),_:1},8,["onClick"])])])]),i("small",X,"共 "+r(h.pagination.total)+" 筆",1)]),m(z,{class:"md:hidden",list:u(M),loading:h.loading,onVerifyTax:F.handleVerifyTax,onOnDownload:F.handleDownload},null,8,["list","loading","onVerifyTax","onOnDownload"]),m(T,{columns:h.columns,"table-data":u(D),loading:h.loading,total:h.pagination.total,take:h.pagination.take,page:h.pagination.page,"onUpdate:page":f[2]||(f[2]=e=>h.pagination.page=e),class:"hidden md:block"},{member:d((({row:e})=>[i("div",Z,[(l(!0),n(s,null,o(e.member,((e,a)=>(l(),n("div",{key:a,class:"flex items-center"},[i("div",J,[i("span",K,r(F.handleFormatMemberLabel(a)),1),i("span",null,r(e||"-"),1)])])))),128))])])),name:d((({row:e})=>[i("div",{class:"cursor-pointer hover:opacity-70 text-primary-500 flex items-center gap-x-1 w-fit",onClick:a=>F.handleDownload(e)},[i("p",null,r(e.name),1),m(w,null,{default:d((()=>[m(v)])),_:1})],8,P)])),status:d((({row:e})=>[m(k,{effect:"plain",round:"",size:"small",type:e.statusType},{default:d((()=>[c(r(e.status),1)])),_:2},1032,["type"])])),action:d((({row:e})=>[t(i("button",{class:"cursor-pointer hover:opacity-70 text-primary-500",onClick:a=>F.handleVerifyTax({file:e.name,type:"verify"})}," 通過 ",8,W),[[p,!e.name.includes("verified")]]),t(i("button",{class:"cursor-pointer hover:opacity-70 text-gray-500",onClick:a=>F.handleVerifyTax({file:e.name,type:"revoke"})}," 撤銷 ",8,ee),[[p,e.name.includes("verified")]])])),_:1},8,["columns","table-data","loading","total","take","page"])]),m(V,{onClick:Y(F.handleScrollToTop,["prevent"])},null,8,["onClick"])])}}},[["__scopeId","data-v-66e6abdb"]]);export{ae as default};
